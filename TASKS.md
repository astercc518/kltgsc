# 开发任务清单 (Development Tasks)

本文档详细列出了每个开发阶段的具体任务、验收标准和真实环境测试要求。

## 任务管理说明

- ✅ **已完成**: 任务已完成并通过验收
- 🚧 **进行中**: 任务正在开发中
- ⏳ **待开始**: 任务尚未开始
- ❌ **阻塞**: 任务因依赖问题被阻塞

---

## Stage 1: 基础框架搭建 (Infrastructure) ✅ [Completed]

**目标**: 跑通前后端流程，验证开发环境。

### 1.1 后端基础设置 ✅

#### 任务清单
- [x] 验证 FastAPI 项目结构完整性
- [x] 确认 SQLModel + SQLite 数据库连接正常
- [x] 配置 CORS 中间件，允许前端跨域请求
- [x] 实现 `/api/v1/health` 健康检查接口
- [x] 配置环境变量管理（`.env` 文件支持）
- [x] 编写基础 API 文档（FastAPI 自动生成）

#### 验收标准（Web端真实环境）
1. **后端服务启动**
   - 运行 `docker-compose up backend` 或 `uvicorn app.main:app --reload`
   - 访问 `http://localhost:8000/docs` 能看到 Swagger UI
   - 访问 `http://localhost:8000/api/v1/health` 返回 `{"status": "ok", "message": "Backend is running"}`

2. **数据库连接**
   - 检查 `tgsc.db` 文件已创建
   - 在 Swagger UI 中测试任意接口，确认数据库操作正常

3. **CORS 配置**
   - 前端能成功调用后端 API（无 CORS 错误）
   - 浏览器控制台无跨域相关错误

### 1.2 前端基础设置 ✅

#### 任务清单
- [x] 验证 React + Vite 项目结构
- [x] 配置 Ant Design 主题和全局样式
- [x] 搭建基础 Layout（侧边栏、顶部栏、内容区）
- [x] 配置路由（React Router）
- [x] 配置 Axios 请求拦截器，统一处理 API 调用
- [x] 实现 API 客户端封装（`src/services/api.ts`）

#### 验收标准（Web端真实环境）
1. **前端服务启动**
   - 运行 `npm run dev` 或 `docker-compose up frontend`
   - 访问 `http://localhost:3000` 能看到页面正常加载
   - 无控制台错误

2. **Layout 展示**
   - 左侧有可折叠的侧边栏，显示 "TGSC" Logo
   - 侧边栏有菜单项（Dashboard、Accounts 等）
   - 顶部有 Header 区域
   - 内容区域能正常显示路由内容

3. **API 调用测试**
   - 在浏览器开发者工具 Network 标签中，能看到前端成功调用 `http://localhost:8000/api/v1/health`
   - 前端页面能显示后端返回的数据（可在 Dashboard 页面显示健康状态）

### 1.3 前后端集成测试 ✅

#### 任务清单
- [x] 前端调用后端 `/api/v1/health` 接口
- [x] 前端显示后端返回的状态信息
- [x] 验证错误处理（后端关闭时前端显示友好错误提示）

#### 验收标准（Web端真实环境）
1. **正常流程**
   - 打开 `http://localhost:3000`
   - Dashboard 页面显示 "Backend Status: OK" 或类似信息
   - 信息来自后端 `/api/v1/health` 接口

2. **错误处理**
   - 关闭后端服务
   - 刷新前端页面
   - 前端应显示 "无法连接到后端服务" 或类似的错误提示
   - 不应出现白屏或未捕获的错误

### Stage 1 整体验收 ✅

**验收清单**:
- [x] 后端服务正常启动，Swagger UI 可访问
- [x] 前端服务正常启动，页面正常显示
- [x] 前端能成功调用后端健康检查接口
- [x] 前后端通过 Docker Compose 能同时启动
- [x] 浏览器控制台无错误（需手动验证）
- [x] 完成 Stage 1 验收报告（详见 `WEB_ACCEPTANCE_REPORT.md`）

**验收状态**: ✅ **通过**  
**验收日期**: 2026-01-06  
**测试结果**: 16/16 自动化测试通过，0 失败

---

## Stage 2: 核心资源管理 (Core Resource Mgmt) ✅

**目标**: 建立支持大规模账号运行的基础数据库与管理界面。

### 2.1 代理池管理 - 后端 ✅

#### 任务清单
- [x] 完善 Proxy 数据模型（添加必要字段）
- [x] 实现代理批量导入接口（支持 txt 文件，格式：`ip:port:user:pass`）
- [x] 实现代理列表查询接口（分页、筛选、排序）
- [x] 实现代理连通性检测接口（单个/批量）
- [x] 实现代理状态更新接口（标记为 active/dead）
- [x] 编写代理检测服务（使用 `requests` 或 `aiohttp` 测试代理）

#### 验收标准（Web端真实环境）
1. **代理导入**
   - 准备一个包含 5-10 个代理的 txt 文件（格式：`ip:port:user:pass`）
   - 在前端上传该文件
   - 后端成功解析并存入数据库
   - 前端显示导入成功的代理数量

2. **代理列表**
   - 前端显示代理列表表格
   - 表格包含：IP、端口、用户名、密码、状态、最后检查时间
   - 支持分页（每页 20 条）
   - 支持按状态筛选（active/dead）

3. **代理检测**
   - 点击"检测代理"按钮（单个或批量）
   - 后端异步检测代理连通性
   - 前端实时显示检测进度（可选：WebSocket 或轮询）
   - 检测完成后，代理状态更新为 active 或 dead
   - 在真实环境中，至少有一个代理能通过检测（如果使用真实代理）

### 2.2 代理池管理 - 前端 ✅

#### 任务清单
- [x] 创建代理管理页面（`/proxies`）
- [x] 实现代理列表表格（Ant Design Table）
- [x] 实现代理上传组件（支持拖拽上传）
- [x] 实现代理检测按钮和状态显示
- [x] 实现代理删除功能
- [x] 添加代理状态指示灯（绿色=active，红色=dead）

#### 验收标准（Web端真实环境）
1. **页面展示**
   - 访问 `http://localhost:3000/proxies` 能看到代理管理页面
   - 页面布局美观，符合 Ant Design 设计规范
   - 表格数据正确显示

2. **功能操作**
   - 上传代理文件：选择文件 → 点击上传 → 看到成功提示 → 列表刷新
   - 检测代理：点击"检测"按钮 → 看到加载状态 → 检测完成 → 状态更新
   - 删除代理：点击删除 → 确认 → 代理从列表移除

### 2.3 账号仓库 - 后端 ✅

#### 任务清单
- [x] 完善 Account 数据模型（确保与 Proxy 关联正确）
- [x] 实现 Session 文件批量上传接口（支持多文件上传）
- [x] 实现 Session 文件解析（提取 phone_number、api_id、api_hash 等）
- [x] 实现账号列表查询接口（分页、筛选、关联 Proxy 信息）
- [x] 实现账号状态查询接口（单个账号）
- [x] 实现账号删除接口
- [x] 实现账号与代理自动绑定逻辑（从代理池分配空闲代理）

#### 验收标准（Web端真实环境）
1. **账号导入**
   - 准备 3-5 个 `.session` 文件（Pyrogram 格式）
   - 在前端批量上传这些文件
   - 后端自动解析 Session 信息（phone_number 等）
   - 后端自动从代理池分配代理（如果有可用代理）
   - 前端显示导入成功的账号列表

2. **账号列表**
   - 前端显示账号列表表格
   - 表格包含：手机号、状态、绑定的代理、最后活跃时间、创建时间
   - 支持分页
   - 支持按状态筛选（init/active/banned/spam_block）

3. **代理绑定**
   - 导入账号时，如果代理池有可用代理，自动绑定
   - 在账号列表中能看到每个账号绑定的代理 IP

### 2.4 账号仓库 - 前端 ✅

#### 任务清单
- [x] 创建账号管理页面（`/accounts`）
- [x] 实现账号列表表格
- [x] 实现 Session 文件批量上传组件（支持多选）
- [x] 实现账号状态指示灯（不同状态不同颜色）
- [x] 实现账号详情查看（Modal 或 Drawer）
- [x] 实现账号删除功能

#### 验收标准（Web端真实环境）
1. **页面展示**
   - 访问 `http://localhost:3000/accounts` 能看到账号管理页面
   - 表格正确显示账号信息
   - 状态用不同颜色的标签或指示灯显示

2. **功能操作**
   - 上传 Session：选择多个文件 → 上传 → 看到进度 → 成功提示 → 列表刷新
   - 查看详情：点击账号行 → 弹出详情 Modal → 显示完整信息（包括代理信息）
   - 删除账号：点击删除 → 确认 → 账号从列表移除

### 2.5 账号验活功能 ✅

#### 任务清单
- [x] 实现 Pyrogram 客户端初始化服务
- [x] 实现账号状态检测逻辑（连接 Telegram、检查账号状态）
- [x] 实现单个账号验活接口
- [x] 实现批量账号验活接口（返回任务 ID）
- [x] 处理常见错误（FloodWait、Spamblock 等）

#### 验收标准（Web端真实环境）
1. **单个账号验活**
   - 在账号列表中点击"检查状态"按钮
   - 后端尝试连接 Telegram（使用 Session 和代理）
   - 前端显示加载状态
   - 验活完成后，账号状态更新为 `active` 或 `banned` 等
   - 如果账号有效，`last_active` 时间更新

2. **批量验活**
   - 选择多个账号，点击"批量检查"
   - 后端创建异步任务
   - 前端显示任务进度（可选）
   - 所有账号检查完成后，状态更新

3. **错误处理**
   - 如果 Session 无效，状态标记为相应错误
   - 如果代理不可用，显示友好错误提示
   - 如果遇到 FloodWait，记录等待时间

### Stage 2 整体验收 ⏳

**验收清单**:
- [ ] 能够导入 10+ 个代理，并在前端查看列表
- [ ] 能够检测代理连通性，状态正确更新
- [ ] 能够导入 5+ 个账号（Session 文件），并在前端查看列表
- [ ] 账号能自动绑定代理（如果有可用代理）
- [ ] 能够手动点击"检查状态"，验活单个账号
- [ ] 账号状态正确显示（active/banned 等）
- [ ] 所有操作在 Web 端完成，无需命令行
- [ ] 完成 Stage 2 验收报告（截图 + 测试数据）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-06  
**详细总结**: 见 `STAGE2_SUMMARY.md`

---

## Stage 3: 任务调度与并发控制 (Scheduler & Queue) ✅

**目标**: 引入异步任务队列，解耦 Web 请求与 TG 操作，支持并发。

### 3.1 Redis 与任务队列设置 ✅

#### 任务清单
- [x] 配置 Redis 服务（Docker Compose）
- [x] 选择任务队列方案（Celery 或 ARQ）
- [x] 实现任务队列初始化
- [x] 实现任务状态查询接口
- [x] 实现任务结果查询接口

#### 验收标准（Web端真实环境）
1. **Redis 服务**
   - `docker-compose up redis` 能正常启动
   - 后端能成功连接 Redis
   - 在 Swagger UI 中测试任务相关接口，确认 Redis 连接正常

2. **任务队列**
   - 提交一个测试任务
   - 能在 Redis 中看到任务数据（使用 `redis-cli` 或 Redis 管理工具）
   - 任务能正常执行并返回结果

### 3.2 并发控制实现 ✅

#### 任务清单
- [x] 实现全局信号量（Semaphore）限制并发数
- [x] 实现任务队列 Worker
- [x] 实现账号验活任务（异步版本）
- [x] 实现任务进度跟踪（可选：使用 Redis 存储进度）

#### 验收标准（Web端真实环境）
1. **并发限制**
   - 配置最大并发数为 5
   - 同时提交 20 个账号验活任务
   - 观察日志，确认同时只有 5 个任务在执行
   - 其他任务在队列中等待

2. **任务执行**
   - 提交批量验活任务（50 个账号）
   - 前端显示任务已提交
   - 后端日志显示任务正在并发执行
   - 所有任务完成后，账号状态正确更新
   - Web 请求不阻塞（可以继续操作其他功能）

### 3.3 前端任务管理 ✅

#### 任务清单
- [x] 实现任务列表页面（可选）
- [x] 实现任务状态显示（pending/running/completed/failed）
- [x] 实现任务进度条（如果支持进度跟踪）
- [x] 实现任务结果查看

#### 验收标准（Web端真实环境）
1. **任务提交**
   - 在账号管理页面点击"全部检查"
   - 前端显示"任务已提交，任务 ID: xxx"
   - 可以继续浏览其他页面，不影响任务执行

2. **任务状态**
   - 如果有任务管理页面，能看到任务列表
   - 任务状态正确显示（运行中/已完成/失败）
   - 任务完成后，能看到执行结果（成功/失败数量）

### Stage 3 整体验收 ✅

**验收清单**:
- [x] Redis 服务正常运行
- [x] 能够提交异步任务，Web 请求立即返回
- [x] 并发控制生效（同时执行的任务数不超过限制）
- [x] 能够同时检查 50 个账号，不阻塞主线程
- [x] 任务完成后，账号状态正确更新
- [x] 前端能查看任务状态（可选）
- [x] 完成 Stage 3 验收报告（日志截图 + 并发测试结果）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-13  
**详细总结**: 实现了基于 Celery + Redis 的异步任务调度系统。配置了 Redis 作为 Celery 的 Broker 和 Result Backend。实现了全局 Redis Semaphore 信号量机制，用于控制 Telegram API 的并发请求量。前端开发了任务管理页面 (`/tasks`)，支持查看 Active/Reserved/Scheduled 任务状态，并支持手动终止任务。

---

## Stage 4: 基础采集与营销 (Scraping & Basic Marketing) ✅

**目标**: 实现最核心的业务价值。

### 4.1 群成员采集 - 后端 ✅

#### 任务清单
- [x] 创建 TargetUser 数据模型
- [x] 实现加入群组功能（使用 Pyrogram）
- [x] 实现获取群成员接口
- [x] 实现成员过滤逻辑（去重、过滤管理员/机器人、按活跃时间筛选）
- [x] 实现成员数据存储

#### 验收标准（Web端真实环境）
1. **加入群组**
   - 在前端输入群组链接（如 `https://t.me/example_group`）
   - 选择用于操作的账号
   - 点击"加入群组"
   - 后端使用该账号加入群组
   - 前端显示"加入成功"

2. **采集成员**
   - 输入已加入的群组链接
   - 选择账号
   - 点击"采集成员"
   - 后端获取群成员列表
   - 前端显示采集到的成员数量
   - 在"目标用户"页面能看到采集到的用户列表

3. **数据过滤**
   - 采集完成后，检查数据库
   - 确认没有重复用户
   - 确认管理员和机器人已被过滤
   - 如果设置了活跃时间筛选，确认只包含符合条件的用户

### 4.2 群成员采集 - 前端 ✅

#### 任务清单
- [x] 创建采集页面（`/scraping`）
- [x] 实现群组链接输入表单
- [x] 实现账号选择器
- [x] 实现采集按钮和进度显示
- [x] 创建目标用户列表页面（`/target-users`）
- [x] 实现用户列表表格（分页、筛选）

#### 验收标准（Web端真实环境）
1. **采集界面**
   - 访问 `/scraping` 页面
   - 输入群组链接
   - 选择账号（下拉选择）
   - 点击"开始采集"
   - 看到加载状态和进度提示
   - 采集完成后显示成功消息和成员数量

2. **用户列表**
   - 访问 `/target-users` 页面
   - 看到采集到的用户列表
   - 表格显示：用户 ID、用户名、昵称、采集时间
   - 支持分页和搜索

### 4.3 私信群发 - 后端 ✅

#### 任务清单
- [x] 创建发送任务数据模型（SendTask）
- [x] 实现创建发送任务接口
- [x] 实现任务执行逻辑（选择账号、选择目标用户、发送消息）
- [x] 实现基础风控（随机延迟 10-60 秒）
- [x] 实现任务状态跟踪
- [x] 实现发送记录存储（成功/失败）

#### 验收标准（Web端真实环境）
1. **创建任务**
   - 在前端创建发送任务
   - 选择 5 个源账号
   - 选择 20 个目标用户
   - 输入消息内容（如 "Hello, this is a test message"）
   - 提交任务

2. **任务执行**
   - 任务提交后，后端开始执行
   - 观察日志，确认有随机延迟（10-60 秒之间）
   - 确认消息成功发送到目标用户
   - 在 Telegram 客户端（目标账号）验证收到消息

3. **结果统计**
   - 任务完成后，前端显示发送结果
   - 显示成功数量、失败数量
   - 失败原因记录（如果失败）

### 4.4 私信群发 - 前端 ✅

#### 任务清单
- [x] 创建发送任务页面（`/marketing/send`）
- [x] 实现账号多选组件
- [x] 实现目标用户多选组件（支持全选、按条件筛选）
- [x] 实现消息内容输入（支持文本、图片等）
- [x] 实现任务提交和状态显示
- [x] 实现发送记录查看

#### 验收标准（Web端真实环境）
1. **任务创建界面**
   - 访问 `/marketing/send` 页面
   - 选择源账号（多选，显示账号手机号）
   - 选择目标用户（多选，显示用户信息）
   - 输入消息内容
   - 点击"创建任务"

2. **任务执行**
   - 任务创建后，显示任务状态（运行中）
   - 显示发送进度（已发送/总数）
   - 任务完成后，显示最终结果

3. **消息验证**
   - 在真实的 Telegram 客户端登录目标账号
   - 确认收到了来自源账号的消息
   - 消息内容正确

### Stage 4 整体验收 ✅

**验收清单**:
- [x] 能够加入一个真实群组（使用测试账号）
- [x] 能够采集群组成员（至少 10 个成员）
- [x] 采集的数据正确过滤（无重复、无机器人）
- [x] 能够创建发送任务（5 个账号，20 个目标用户）
- [x] 消息成功发送到目标用户（在 Telegram 客户端验证）
- [x] 发送过程有随机延迟（风控生效）
- [x] 所有操作在 Web 端完成
- [x] 完成 Stage 4 验收报告（截图 + 真实发送记录）

**开发状态**: ✅ **已完成**
**开发日期**: 2026-01-13
**详细总结**: 完成了核心的营销功能模块。
1. **群成员采集**: 实现了 `TargetUser` 模型和采集 API。支持使用指定账号加入群组，并采集群组成员信息（支持去重和机器人过滤）。前端提供了采集界面和目标用户管理列表。
2. **私信群发**: 实现了 `SendTask` 模型和基于 Celery 的异步发送任务。支持创建群发任务，选择多个源账号和多个目标用户，并配置随机延迟。后端 worker 实现了轮询分发和并发控制逻辑。前端提供了任务创建和状态监控界面。

---

## Stage 5: 高级风控与自动化 (Advanced Anti-Ban) ✅

**目标**: 保护账号安全，实现无人值守。

### 5.1 指纹系统 ✅

#### 任务清单
- [x] 实现设备指纹生成逻辑（device_model、system_version、app_version）
- [x] 实现指纹持久化（存储到 Account 表）
- [x] 实现 Pyrogram 客户端初始化时使用指纹
- [x] 实现指纹随机化（可选：为不同账号生成不同指纹）

#### 验收标准（Web端真实环境）
1. **指纹生成**
   - 导入新账号时，自动生成设备指纹
   - 在账号详情中能看到设备信息（device_model、system_version 等）
   - 不同账号的指纹不同（如果启用随机化）

2. **指纹使用**
   - 账号验活时，使用存储的指纹初始化客户端
   - 在 Telegram 客户端中查看账号信息，确认设备信息正确

### 5.2 熔断机制 ✅

#### 任务清单
- [x] 实现异常捕获（FloodWait、PeerFlood、Spamblock）
- [x] 实现账号冷却状态管理
- [x] 实现自动暂停任务逻辑
- [x] 实现冷却时间到期自动恢复
- [x] 实现异常报警（可选：通过 API 响应返回错误详情）

#### 验收标准（Web端真实环境）
1. **异常处理**
   - 模拟触发 FloodWait 错误（或使用真实场景）
   - 系统自动捕获异常
   - 账号状态更新为"flood_wait"
   - 该账号的任务自动暂停

2. **状态显示**
   - 在账号列表中，冷却中的账号显示特殊状态
   - 显示冷却剩余时间
   - 冷却时间到期后，账号状态自动恢复为可用（需手动或定时再次检查）

3. **任务保护**
   - 账号进入冷却后，新任务不会分配给该账号
   - 正在执行的任务会安全停止（不强制断开）

### 5.3 自动化养号 ✅

#### 任务清单
- [x] 创建养号任务数据模型
- [x] 实现养号策略配置（浏览频道、群内发表情、随机在线时长）
- [x] 实现养号任务调度（定时执行）
- [x] 实现随机行为生成（随机选择操作、随机时间间隔）

#### 验收标准（Web端真实环境）
1. **任务创建**
   - 在前端创建养号任务
   - 选择要养号的账号列表
   - 配置养号策略（如：每天浏览 3 个频道，在 2 个群内发表情）
   - 提交任务

2. **任务执行**
   - 任务按计划执行
   - 观察日志，确认账号执行了随机行为
   - 在 Telegram 客户端验证（如：看到账号在群内发表了表情）

3. **行为随机化**
   - 不同账号执行不同的操作
   - 操作时间间隔随机（不固定）
   - 行为看起来自然（不像机器人）

### Stage 5 整体验收 ✅

**验收清单**:
- [x] 账号有唯一的设备指纹
- [x] 遇到 FloodWait 等异常时，系统自动处理，账号进入冷却
- [x] 冷却中的账号不会接收新任务
- [x] 能够创建和执行养号任务
- [x] 养号行为看起来自然（随机化生效）
- [x] 所有功能在 Web 端可配置和查看
- [x] 完成 Stage 5 验收报告（异常处理截图 + 养号任务记录）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-13  
**详细总结**: 实现了完整的设备指纹生成与持久化，确保每个账号模拟真实的 Android 设备。引入了熔断机制，自动捕获 FloodWait 和 Spamblock 异常并更新账号状态。前端已完成对接，支持在 Web 端查看指纹信息、冷却状态以及创建自动化养号任务。

---

## Stage 6: AI 智能营销 (AI Marketing) ✅

**目标**: 提升转化率。

### 6.1 AI 集成 ✅

#### 任务清单
- [x] 选择 LLM 服务（OpenAI / Anthropic / Ollama）
- [x] 实现 LLM API 调用封装
- [x] 实现智能回复功能（收到私信 → AI 生成回复 → 发送）
- [x] 实现角色设定（为不同账号设定不同人设）
- [x] 实现上下文管理（记住对话历史）

#### 验收标准（Web端真实环境）
1. **AI 配置**
   - 在系统设置中配置 LLM API Key
   - 测试 API 连接（点击"测试连接"按钮）
   - 确认连接成功

2. **智能回复**
   - 向受控账号发送私信（从外部 Telegram 账号）
   - 系统自动检测到新消息
   - AI 生成回复内容
   - 自动发送回复
   - 在 Telegram 客户端验证收到 AI 回复

3. **角色设定**
   - 为账号 A 设定人设："友好的客服，语气正式"
   - 为账号 B 设定人设："活泼的销售，语气轻松"
   - 向两个账号发送相同的问题
   - 验证回复内容符合各自的人设

### 6.2 炒群脚本 ✅

#### 任务清单
- [x] 实现剧本管理（创建对话剧本）
- [x] 实现多账号配合逻辑（A 提问，B 回答）
- [x] 实现炒群任务调度
- [x] 实现自然对话生成（基于 LLM）

#### 验收标准（Web端真实环境）
1. **剧本创建**
   - 在前端创建炒群剧本
   - 设定角色 A："提问者，询问产品信息"
   - 设定角色 B："回答者，介绍产品优势"
   - 配置对话流程

2. **任务执行**
   - 创建炒群任务，选择目标群组
   - 分配账号 A 和账号 B
   - 启动任务
   - 在目标群组中观察对话
   - 确认对话自然，符合剧本设定

3. **多账号配合**
   - 使用 3+ 个账号参与炒群
   - 确认账号之间的对话有逻辑关联
   - 对话时间间隔自然（不同时发送）

### Stage 6 整体验收 ✅

**验收清单**:
- [x] LLM API 集成成功，能生成自然回复
- [x] 智能回复功能正常工作（收到消息自动回复）
- [x] 能够创建和执行炒群任务
- [x] 炒群对话看起来自然（不像机器人）
- [x] 多账号配合流畅
- [x] 所有功能在 Web 端可配置
- [x] 完成 Stage 6 验收报告（AI 回复示例 + 炒群对话截图）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-13  
**详细总结**: 完成了基于 LLM 的核心 AI 营销功能。集成了 OpenAI 接口，实现了基于上下文的私信自动回复服务。开发了高级的炒群脚本系统，支持多角色定义、LLM 自动生成对话内容、以及多账号协同执行。前端新增了 AI 配置和炒群脚本管理页面，实现了完整的闭环。

---

## Stage 7: CRM 客户管理 (CRM & Inbox) ✅

**目标**: 流量承接与转化。

### 7.1 聚合聊天 ✅

#### 任务清单
- [x] 实现 WebSocket 服务（后端）
- [x] 实现消息实时推送（新消息 → WebSocket → 前端）
- [x] 实现统一聊天界面（显示所有账号的私信）
- [x] 实现消息发送功能（从 Web 端发送消息）
- [x] 实现消息标记（已读/未读）

#### 验收标准（Web端真实环境）
1. **实时消息接收**
   - 在 Web 端打开聚合聊天页面
   - 从外部 Telegram 账号向受控账号发送私信
   - Web 端立即显示新消息（无需刷新）
   - 消息显示来源账号、发送者、内容、时间

2. **消息发送**
   - 在 Web 端选择对话
   - 输入回复内容
   - 点击发送
   - 在 Telegram 客户端验证收到消息

3. **多账号管理**
   - 聊天界面显示所有账号的对话列表
   - 可以切换查看不同账号的对话
   - 未读消息有提示（红点或数字）

### 7.2 线索管理 ✅

#### 任务清单
- [x] 创建线索数据模型（Lead）
- [x] 实现自动线索录入（回复私信的用户自动转为线索）
- [x] 实现标签系统（手动/自动打标签）
- [x] 实现跟进记录（记录所有交互历史）
- [x] 实现线索筛选和搜索

#### 验收标准（Web端真实环境）
1. **自动录入**
   - 外部用户向受控账号发送私信
   - 系统自动创建线索记录
   - 在线索列表中能看到新线索

2. **标签管理**
   - 为线索打标签（如"高意向"、"已询价"）
   - 按标签筛选线索
   - 自动标签规则生效（如：包含"价格"的消息自动打"询价"标签）

3. **跟进记录**
   - 查看线索详情
   - 能看到所有聊天历史
   - 能看到操作记录（已拉群、已私信等）

### Stage 7 整体验收 ✅

**验收清单**:
- [x] WebSocket 连接正常，消息实时推送
- [x] 聚合聊天界面能显示所有账号的对话
- [x] 能从 Web 端发送消息，Telegram 客户端能收到
- [x] 线索自动录入功能正常
- [x] 标签系统正常工作
- [x] 跟进记录完整
- [x] 所有功能在 Web 端可用
- [x] 完成 Stage 7 验收报告（聊天界面截图 + 线索管理截图）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-13  
**详细总结**: 完成了 CRM 系统的核心功能。后端实现了 WebSocket 服务用于实时消息推送，前端实现了聚合聊天界面 (Inbox)，支持跨账号查看和回复消息。实现了 Lead 数据模型和 API，能够自动将互动的 Telegram 用户录入为销售线索，并支持查看历史消息记录。

---

## Stage 8: 数据看板与运维 (Dashboard & Ops) ✅

**目标**: 宏观监控。

### 8.1 数据统计 ✅

#### 任务清单
- [x] 实现每日发送量统计
- [x] 实现成功率统计
- [x] 实现账号存活率统计
- [x] 实现趋势图（使用 Chart.js 或 ECharts）
- [x] 实现数据导出功能（CSV/Excel）

#### 验收标准（Web端真实环境）
1. **Dashboard 展示**
   - 访问 Dashboard 页面
   - 看到关键指标卡片：总账号数、活跃账号数、今日发送量、成功率等
   - 看到趋势图：7 天发送量趋势、账号存活率趋势等

2. **数据准确性**
   - 统计数据与实际数据一致
   - 趋势图正确反映历史数据
   - 时间筛选功能正常（按日/周/月查看）

3. **数据导出**
   - 点击"导出数据"按钮
   - 下载 CSV 或 Excel 文件
   - 文件内容正确

### 8.2 日志审计 ✅

#### 任务清单
- [x] 实现操作日志记录（所有关键操作）
- [x] 实现日志查询接口（按时间、操作类型、账号筛选）
- [x] 实现日志查看页面（表格展示）
- [x] 实现日志详情查看（显示完整操作信息）

#### 验收标准（Web端真实环境）
1. **日志记录**
   - 执行一些操作（如：导入账号、发送消息、验活账号）
   - 在日志页面能看到这些操作的记录
   - 日志包含：时间、操作类型、操作者、结果、详情

2. **日志查询**
   - 按时间范围筛选日志
   - 按操作类型筛选（如：只查看"发送消息"日志）
   - 按账号筛选（查看某个账号的所有操作）
   - 搜索结果正确

3. **日志详情**
   - 点击日志条目，查看详细信息
   - 详情包含完整的操作上下文（如：发送了哪些消息、目标用户等）

### Stage 8 整体验收 ✅

**验收清单**:
- [x] Dashboard 显示所有关键指标
- [x] 趋势图正确展示历史数据
- [x] 数据导出功能正常
- [x] 操作日志完整记录
- [x] 日志查询功能正常
- [x] 所有功能在 Web 端可用
- [x] 完成 Stage 8 验收报告（Dashboard 截图 + 日志查询截图）

**开发状态**: ✅ **已完成**  
**开发日期**: 2026-01-13  
**详细总结**: 完成了系统的监控与运维模块。升级了 Dashboard，集成了 Recharts 展示发送趋势图和关键业务指标（账号存活率、今日发送量）。实现了完整的操作日志（Operation Log）记录系统，覆盖了登录、账号管理、消息发送等关键操作，并提供了前端日志查询与审计界面。此外，还实现了系统配置页面，方便管理员动态调整系统参数。

---

## Stage 9: 高级转化与增长 (Growth & Conversion Optimization) ⏳

**目标**: 从“主动骚扰”转向“被动引流”，最大化转化率。

### 9.1 关键词监控与被动引流 (Keyword Monitor & Passive Leads) ⏳

#### 任务清单
- [x] 实现群组关键词监听服务 (Listener Worker)
- [x] 实现关键词命中通知与记录
- [x] 实现“托”账号调度逻辑（当关键词命中时，调度 Tier 2 账号介入）
- [x] 升级炒群脚本，支持基于“引用消息”的上下文对话
- [x] 实现前端关键词配置页面

#### 验收标准（Web端真实环境）
1. **关键词命中**
   - 在配置页面添加关键词 "多少钱"
   - 使用任意账号在目标群组发送包含 "多少钱" 的消息
   - 系统捕获该消息，并生成一条 "Monitor Hit" 记录

2. **被动演戏**
   - 关键词命中后，系统自动调度账号 A 和 B
   - 账号 A 引用该消息并回复推荐话术
   - 账号 B 附和
   - 对话看起来自然，无明显机器人痕迹

### 9.2 私域构建与批量拉人 (Inviter System) ⏳

#### 任务清单
- [x] 实现批量拉人 API (`InviteToChannel` / `InviteToGroup`)
- [x] 实现拉人风控控制（单号单日上限、失败跳过、休眠策略）
- [x] 实现前端拉人任务创建界面
- [x] 实现拉人结果统计（成功率、失败原因分析）

#### 验收标准（Web端真实环境）
1. **批量拉人**
   - 创建拉人任务，选择源群（采集数据）和目标群
   - 系统调度账号批量执行 Invite 操作
   - 目标群成员数量增加

2. **风控验证**
   - 设置单号限制为 5 人
   - 任务执行超过 5 人时，自动切换账号或停止

### 9.3 AI 销售代表与意图识别 (AI SDR Agent) ⏳

#### 任务清单
- [x] 优化 System Prompt，支持“引导式提问”配置
- [x] 实现 AI 意图识别（Intent Recognition），自动识别“询价”、“购买”意图
- [x] 实现 AI 自动打标签（通过识别结果调用 CRM 标签 API）
- [x] 实现“高意向强提醒”（WebSocket 推送特殊事件到 Inbox）

#### 验收标准（Web端真实环境）
1. **意图识别**
   - 向受控账号发送 "我想买这个，怎么付款？"
   - AI 识别意图为 "Purchase_Intent"
   - 自动为该用户打上 "高意向" 标签

2. **人工介入**
   - 触发高意向标签后，Inbox 界面收到强提醒（如弹窗或声音）
   - 客服介入接管对话

### 9.4 账号分级管理 (Account Tiering) ⏳

#### 任务清单
- [x] 账号模型添加 `tier` 字段 (Premium/Support/Disposable)
- [x] 实现分级权限控制（如 Premium 号禁止执行 Mass DM）
- [x] 前端账号列表支持按 Tier 筛选和分组展示
- [x] 任务分配逻辑升级（优先分配 Disposable 号执行高风险任务）

#### 验收标准（Web端真实环境）
1. **分级管理**
   - 将账号 A 标记为 Tier 1 (Premium)
   - 尝试使用账号 A 创建群发任务
   - 系统报错或提示“权限不足”，阻止高风险操作

### Stage 9 整体验收 ✅

**验收清单**:
- [x] 关键词监控正常工作，能准确捕获消息
- [x] “托”账号能自动响应关键词并演戏
- [x] 批量拉人功能可用且风控生效
- [x] AI 能准确识别意图并自动打标
- [x] 账号分级权限控制生效
- [x] 完成 Stage 9 验收报告

**开发状态**: ✅ **已完成**
**开发日期**: 2026-01-15
